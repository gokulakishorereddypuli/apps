<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Task Notifier Pro</title>
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --bg: #f8fafc; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .app-card { width: 100%; max-width: 450px; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #1e293b; font-size: 1.5rem; }
        .input-group { display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px; }
        input { padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; outline: none; }
        input:focus { border-color: var(--primary); ring: 2px var(--primary); }
        button { padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .btn-add { background: var(--primary); color: white; }
        .btn-delete { background: #fee2e2; color: var(--danger); padding: 6px 12px; font-size: 0.85rem; }
        .task-list { border-top: 1px solid #f1f5f9; }
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
        .task-name { font-weight: 500; color: #334155; display: block; }
        .task-time { font-size: 0.85rem; color: #64748b; }
    </style>
</head>
<body>

<div class="app-card">
    <h2>My Schedule</h2>
    
    <div class="input-group">
        <input type="text" id="taskName" placeholder="Task description...">
        <input type="datetime-local" id="taskTime">
        <button class="btn-add" onclick="addTask()">Add Task & Enable Alerts</button>
    </div>

    <div id="taskList" class="task-list"></div>
</div>

<script>
    let tasks = JSON.parse(localStorage.getItem('mobileTasks')) || [];

    // Request permission on first interaction
    async function requestNotifyPermission() {
        if (!("Notification" in window)) return false;
        const permission = await Notification.requestPermission();
        return permission === "granted";
    }

    function saveTasks() {
        localStorage.setItem('mobileTasks', JSON.stringify(tasks));
        renderTasks();
    }

    async function addTask() {
        const nameInput = document.getElementById('taskName');
        const timeInput = document.getElementById('taskTime');
        
        if (!nameInput.value || !timeInput.value) {
            alert("Please fill in all fields");
            return;
        }

        const hasPermission = await requestNotifyPermission();

        const newTask = {
            id: Date.now(),
            name: nameInput.value,
            startTime: new Date(timeInput.value).getTime()
        };

        tasks.push(newTask);
        saveTasks();

        // 1. Immediate Notification for Task Added
        if (hasPermission) {
            new Notification("Task Scheduled! âœ…", {
                body: `"${newTask.name}" added for ${new Date(newTask.startTime).toLocaleTimeString()}`,
                icon: "https://cdn-icons-png.flaticon.com/512/190/190411.png"
            });
        }

        nameInput.value = '';
        timeInput.value = '';
    }

    function deleteTask(id) {
        tasks = tasks.filter(t => t.id !== id);
        saveTasks();
    }

    function renderTasks() {
        const container = document.getElementById('taskList');
        container.innerHTML = tasks.length === 0 ? '<p style="color:#94a3b8; text-align:center;">No upcoming tasks</p>' : '';
        
        tasks.sort((a,b) => a.startTime - b.startTime).forEach(t => {
            const div = document.createElement('div');
            div.className = 'task-item';
            div.innerHTML = `
                <div>
                    <span class="task-name">${t.name}</span>
                    <span class="task-time">${new Date(t.startTime).toLocaleString()}</span>
                </div>
                <button class="btn-delete" onclick="deleteTask(${t.id})">Delete</button>
            `;
            container.appendChild(div);
        });
    }

    // 2. Background Countdown Monitoring
    setInterval(() => {
        const now = Date.now();
        const tenMins = 10 * 60 * 1000;

        tasks.forEach(task => {
            const diff = task.startTime - now;
            
            // Only notify if within the 10-minute window
            if (diff <= tenMins && diff > 0) {
                const secsTotal = Math.floor(diff / 1000);
                const mins = Math.floor(secsTotal / 60);
                const secs = secsTotal % 60;

                new Notification(`Upcoming: ${task.name}`, {
                    body: `Starting in ${mins}m ${secs}s`,
                    tag: `countdown-${task.id}`, // Prevents multiple notification windows
                    silent: true,
                    renotify: false
                });
            }
        });
    }, 1000);

    // Initial render
    renderTasks();
</script>

</body>
</html>
